
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Examples &#8212; ONIX Docs 0.0.0 documentation</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copyURLToClipboard.js"></script>
    <script src="http://wavedrom.com/skins/default.js"></script>
    <script src="http://wavedrom.com/wavedrom.min.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Writing Drivers" href="making-drivers.html" />
    <link rel="prev" title="Building liboni" href="build.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../index.html">
    
      <img src="../../_static/onix_open_ephys_logo.svg" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../About/index.html">About</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../Hardware%20Guide/index.html"> Hardware Guide</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../index.html"> API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../Software%20Guide/index.html"> Software Guide</a>
        </li>
        
        
        <li class="nav-item">
            <a class="nav-link nav-external" href="https://open-ephys.org">Open Ephys<i class="fas fa-external-link-alt"></i></a>
        </li>
        
      </ul>


      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/open-ephys/onix-docs" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/openephys" target="_blank" rel="noopener">
              <span><i class="fab fa-twitter-square"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
          
            
  
                <li class="active">
                    <a href="index.html">liboni</a>
                    <ul>
                    
                        <li class="">
                            <a href="onidefs.html">onidefs.h</a>
                        </li>
                    
                        <li class="">
                            <a href="oni.html">oni.h</a>
                        </li>
                    
                        <li class="">
                            <a href="onidriver.html">onidriver.h</a>
                        </li>
                    
                        <li class="">
                            <a href="onix.html">onix.h</a>
                        </li>
                    
                        <li class="">
                            <a href="build.html">Building liboni</a>
                        </li>
                    
                        <li class="active">
                            <a href="">Examples</a>
                        </li>
                    
                        <li class="">
                            <a href="making-drivers.html">Writing Drivers</a>
                        </li>
                    
                    </ul>
                </li>
            
          
            
                <li class="">
                    <a href="../cpponi/index.html">cpponi</a>
                </li>
            
          
            
                <li class="">
                    <a href="../clroni/index.html">clroni</a>
                </li>
            
          
            
                <li class="">
                    <a href="../drivers/index.html">Hardware Driver Translators</a>
                </li>
            
          
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#acquisition-context-creation" class="nav-link">Acquisition Context Creation</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#closing-an-acquisition-context" class="nav-link">Closing an Acquisition Context</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#examining-the-device-table" class="nav-link">Examining the Device Table</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#reading-and-writing-device-registers" class="nav-link">Reading and Writing Device Registers</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#setting-read-and-write-buffer-sizes" class="nav-link">Setting Read and Write Buffer Sizes</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#starting-acquisition" class="nav-link">Starting Acquisition</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#reading-data-frames" class="nav-link">Reading Data Frames</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#writing-data-frames" class="nav-link">Writing Data Frames</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#synchronizing-contexts" class="nav-link">Synchronizing Contexts</a>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/open-ephys/onix-docs/edit/master/source/API Reference/liboni/liboni-example.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="examples">
<span id="liboni-example"></span><h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<p>The following examples demonstrate common uses of <code class="docutils literal notranslate"><span class="pre">liboni</span></code>. They generally
omit checking return codes, which should be done when the library is used in
for real world applications. For instance:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">oni_function</span><span class="p">(...);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="acquisition-context-creation">
<span id="liboni-example-ctx-creation"></span><h2>Acquisition Context Creation<a class="headerlink" href="#acquisition-context-creation" title="Permalink to this headline">¶</a></h2>
<p>Every piece of ONI-complaint host hardware (occupying a single PCIe slot, USB
port, etc) is governed by an acquisition context. Contexts are fully described
by two parameters: a string specifying the hardware driver and an integer
specifying which slot the physical hardware occupies on the host computer.
Context creation and initialization occurs in two function calls.
<a class="reference internal" href="oni.html#c.oni_create_ctx" title="oni_create_ctx"><code class="xref c c-func docutils literal notranslate"><span class="pre">oni_create_ctx()</span></code></a> allocates API-internal resources to hold context state and
returns a handle to the context. <a class="reference internal" href="oni.html#c.oni_init_ctx" title="oni_init_ctx"><code class="xref c c-func docutils literal notranslate"><span class="pre">oni_init_ctx()</span></code></a> loads the required driver,
attempts to connect to the hardware (open communication channels), and,
finally, obtain a device table that maps the acquisition hierarchy governed by
the context. So, for instance, to create an initialize an acquisition context
to govern a PCIe acquisition card using the <a class="reference external" href="https://github.com/KastnerRG/riffa">RIFFA</a> driver, you would use</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span> <span class="o">=</span> <span class="n">oni_create_ctx</span><span class="p">(</span><span class="s">&quot;riffa&quot;</span><span class="p">);</span> <span class="c1">// &quot;riffa&quot; is the driver name</span>
<span class="n">oni_init_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 0 is the host index. You can use -1 to get default slot</span>
</pre></div>
</div>
<p>If the driver translation library <code class="docutils literal notranslate"><span class="pre">onilibrary_&lt;drv_name&gt;.&lt;so/dll&gt;</span></code> cannot be
found by the linker, or the driver finds that the requested index is vacant,
this function will error. Otherwise, it will allocate the required resources to
manage the hardware at the specified host index using the specified driver.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Specifying a host index of -1 will open the default slot and is
useful in cases where there is only on piece of acquisition hardware in the
host computer (e.g. a single PCIe card).</p>
</div>
<p>When multiple pieces of host hardware exist on a single host (e.g. multiple
PCIe cards), a new context must be created and initialization to manage each
one. In some cases (e.g. multiple PCIe cards in a single computer), these
contexts can be synchronized so that each host receiver board shares a common
hardware clock and acquisition trigger (see <a class="reference internal" href="#sync-ctx"><span class="std std-ref">Synchronizing Contexts</span></a> for an example).
This is not always possible. For instance, multiple USB hosts cannot be
synchronized.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><a class="reference internal" href="oni.html#c.oni_init_ctx" title="oni_init_ctx"><code class="xref c c-func docutils literal notranslate"><span class="pre">oni_init_ctx()</span></code></a> cannot be called on a previously
initialized context.  Doing so will return an error.</p>
</div>
<p>If the device configuration is changed following context initialization (e.g. a
headstage is plugged in or turned on), a context reset must be issued which to
instruct the initialized context to re-evaluate its device table. This can be
done via</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_size_t</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reset</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="closing-an-acquisition-context">
<span id="liboni-example-ctx-destruction"></span><h2>Closing an Acquisition Context<a class="headerlink" href="#closing-an-acquisition-context" title="Permalink to this headline">¶</a></h2>
<p>When an acquisition context is no longer needed, it must be disposed to prevent
memory leaks. This is accomplished via</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_destroy_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</pre></div>
</div>
<p>which will free all resources used by the API and underlying device driver and
close system-level descriptors providing links to hardware.</p>
</div>
<div class="section" id="examining-the-device-table">
<span id="liboni-example-device-table"></span><h2>Examining the Device Table<a class="headerlink" href="#examining-the-device-table" title="Permalink to this headline">¶</a></h2>
<p>Following context initialization or reset, it is useful to examine the device
table to see the devices that host has access to. To examine the device table,
we query the context for the number of devices in the table, allocate enough
space to hold the table, and then populate it:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_size_t</span> <span class="n">num_devs</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">num_devs_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_devs</span><span class="p">);</span>
<span class="n">oni_get_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_NUMDEVICES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_devs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_devs_sz</span><span class="p">);</span>

<span class="kt">size_t</span> <span class="n">devices_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oni_device_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_devs</span><span class="p">;</span>
<span class="n">oni_device_t</span> <span class="o">*</span><span class="n">devices</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">devices_sz</span><span class="p">);</span>
<span class="n">oni_get_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_DEVICETABLE</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devices_sz</span><span class="p">);</span>
</pre></div>
</div>
<p>This will return an array of <code class="docutils literal notranslate"><span class="pre">oni_device_t</span></code> structs where <code class="docutils literal notranslate"><span class="pre">oni_device_t</span></code> is
defined as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">oni_size_t</span> <span class="n">idx</span><span class="p">;</span>           <span class="c1">// Complete rsv.rsv.hub.idx device table index</span>
    <span class="n">oni_dev_id_t</span> <span class="n">id</span><span class="p">;</span>          <span class="c1">// Device ID number (see oedevices.h)</span>
    <span class="n">oni_size_t</span> <span class="n">read_size</span><span class="p">;</span>     <span class="c1">// Device data read size per frame in bytes</span>
    <span class="n">oni_size_t</span> <span class="n">write_size</span><span class="p">;</span>    <span class="c1">// Device data write size per frame in bytes</span>

<span class="p">}</span> <span class="n">oni_device_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><code class="docutils literal notranslate"><span class="pre">device_t.idx</span></code> is the fully qualified address (hub.index) of a
device within the acquisition hierarchy. Do not expect these values to increase
linearly with the position in array returned when querying the device table as
some bit ranges are used to specifiy the hub address.</p>
</div>
</div>
<div class="section" id="reading-and-writing-device-registers">
<span id="liboni-example-read-write-reg"></span><h2>Reading and Writing Device Registers<a class="headerlink" href="#reading-and-writing-device-registers" title="Permalink to this headline">¶</a></h2>
<p>It is often necessary to inspect and configure devices prior to or during
acquisition. As described in the ONI specification, a device is a leaf element
in the device table with <em>at least</em> the following properties:</p>
<ol class="arabic simple">
<li><p>Its own register address space</p></li>
<li><p>Register access through a standardized register programming interface</p></li>
<li><p>A datasheet that describes access to these registers</p></li>
</ol>
<p>Device registers can be read as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_reg_val_t</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">oni_read_reg</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">dev_idx</span></code> is the fully specified device table index (hub.index) found
in the device table, <code class="docutils literal notranslate"><span class="pre">addr</span></code> is the register address as specified within the
ONI device datasheet. Because this is a register read, <code class="docutils literal notranslate"><span class="pre">val</span></code> is just a
pointer to a register to be filled during the read. This function will return
an error if the context is in an inappropriate state (e.g. not initialized),
the specified device is not in the device table, or the register is write-only.
Registers can be written as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_reg_val_t</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">oni_write_reg</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</pre></div>
</div>
<p>where the function arguments have the same definitions as <code class="docutils literal notranslate"><span class="pre">oni_read_reg</span></code>.
This function will return an error if the context is in an inappropriate state,
the device does not exist in the device table, or the register is read-only.</p>
</div>
<div class="section" id="setting-read-and-write-buffer-sizes">
<span id="liboni-example-set-buffers"></span><h2>Setting Read and Write Buffer Sizes<a class="headerlink" href="#setting-read-and-write-buffer-sizes" title="Permalink to this headline">¶</a></h2>
<p>After context initialization, the internal read and write buffers can be
manually specified. These buffers exist in order to reduce copying.</p>
<ul class="simple">
<li><p>During a called <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code>, the read buffer is checked to see if it
contains data. If so, the return frame is simply a zero-copy “view” into this
memory.  If not, a block read is performed to fill the buffer, and again, the
frame is a view into the beginning of this newly allocated block.</p></li>
<li><p>During a call to <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code>, a very similar process occurs in the
opposite direction, using the write buffer. Write frames are views into a
pre-allocated memory block.</p></li>
</ul>
<p>The size of these buffers dictates a trade off between response bandwidth and
latency, especially during frame reads. In the case of reads, smaller buffers
will be filled faster by the hardware and allow access to data that is closer
in time to its physical creation. However, smaller buffers increase the memory
allocation rate and decrease the maximum bandwidth of the read link.</p>
<p>For this reason, we have chosen to make the read and write buffer size easily
tunable by the user to optimize for different computer capabilities, data
bandwidths, and required response latencies. The buffer sizes default to the
minimum size for a given device table (the maximum frame read and write sizes
across devices int the table aligned to the bus width of hardware communication
link). This provides the lowest latency, but is optimal only for very low
bandwidth acquisition and deterministic and low-latency threads (e.g. those
found on real-time operating system). On a normal computer, these buffers can
be set manually to optimize the bandwidth/latency trade off. For example, to
set the buffer read and write sizes to 1024 and 8192 bytes respectively, use
<code class="docutils literal notranslate"><span class="pre">oni_set_opt</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">block_size_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_BLOCKREADSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size_sz</span><span class="p">);</span>

<span class="n">block_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
<span class="n">block_size_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_BLOCKWRITESIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size_sz</span><span class="p">);</span>
</pre></div>
</div>
<p>If you attempt to set the buffer size to less than the minimal required in a
particular context, these functions will return an error. To examine the buffer
sizes, use <code class="docutils literal notranslate"><span class="pre">oni_get_opt</span></code> as follows</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">oni_size_t</span> <span class="n">block_size</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">block_size_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>

<span class="n">oni_get_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_BLOCKREADSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size_sz</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Block read size: %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

<span class="n">oni_get_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_BLOCKWRITESIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size_sz</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Write pre-allocation size: %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="starting-acquisition">
<span id="start-ctx"></span><h2>Starting Acquisition<a class="headerlink" href="#starting-acquisition" title="Permalink to this headline">¶</a></h2>
<p>Prior to reading and writing to/from the high bandwidth data streams,
acquisition must be started. To do this, write 1 to the <code class="docutils literal notranslate"><span class="pre">ONI_OPT_RUNNING</span></code>
context option:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oni_size_t</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Following the start of data acqusition, hardware memory
resources are used to queue incoming device data. To prevent buffer overflows,
the user must issue calls to <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> fast enough to keep up with
data production.</p>
</div>
<p>To reset the main system clock counter (frame timer) at any point during or
prior to starting acquisition, write 1 to the <code class="docutils literal notranslate"><span class="pre">ONI_OPT_RESETACQCOUNTER</span></code>
context option:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_RESETACQCOUNTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oni_size_t</span><span class="p">));</span>
</pre></div>
</div>
<p>Often, the start of data acquisition should precisely co-occur with a clock
reset. To perform both a clock reset and acquisition start in perfect sync,
write 2 to the <code class="docutils literal notranslate"><span class="pre">ONI_OPT_RESETACQCOUNTER</span></code> context option:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// NOTE: this changed to 2 compared to previous example</span>
<span class="n">oni_set_opt</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ONI_OPT_RESETACQCOUNTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oni_size_t</span><span class="p">));</span>
</pre></div>
</div>
<p>This will reset the clock and automatically start acquisition (set
<code class="docutils literal notranslate"><span class="pre">ONI_OPT_RUNNING</span></code> to 1).</p>
</div>
<div class="section" id="reading-data-frames">
<span id="liboni-example-read-frame"></span><h2>Reading Data Frames<a class="headerlink" href="#reading-data-frames" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="oni.html#c.oni_frame_t" title="oni_frame_t"><code class="xref c c-struct docutils literal notranslate"><span class="pre">oni_frame_t</span></code></a>’s are minimal packets containing metadata and raw binary
data blocks from a single device within the device table. A
<a class="reference internal" href="onidefs.html#c.oni_size_t" title="oni_size_t"><code class="xref c c-struct docutils literal notranslate"><span class="pre">oni_size_t</span></code></a> is defined as</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">oni_frame</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">dev_idx</span><span class="p">;</span>  <span class="c1">// Device index that produced or accepts the frame</span>
    <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">data_sz</span><span class="p">;</span>  <span class="c1">// Size in bytes of data buffer</span>
    <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">time</span><span class="p">;</span>     <span class="c1">// Frame time (ACQCLKHZ)</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>           <span class="c1">// Raw data block</span>
<span class="p">};</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">dev_idx</span></code> is the fully qualified device index within the device table
(hub.index), <code class="docutils literal notranslate"><span class="pre">data_sz</span></code> is the size in bytes of the raw data block, <code class="docutils literal notranslate"><span class="pre">time</span></code>
is the system clock count that indicates the frame creation time, and, <code class="docutils literal notranslate"><span class="pre">data</span></code>
is a pointer to the raw data block. A single frames can be read from an
acquisition context after it is started (see <a class="reference internal" href="#start-ctx"><span class="std std-ref">Starting Acquisition</span></a>) using repeated
calls to <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Read a frame</span>
<span class="n">oni_frame_t</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">oni_read_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>

<span class="c1">// Perform desired operations with frame</span>

<span class="c1">// Dispose of frame</span>
<span class="n">oni_destroy_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</pre></div>
</div>
<p>In the preceding example, <code class="docutils literal notranslate"><span class="pre">frame</span></code> is initialized to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> because a call
to <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> will assign its contents to an existing, pre-allocated
memory block (see <a class="reference internal" href="#liboni-example-set-buffers"><span class="std std-ref">Setting Read and Write Buffer Sizes</span></a>). <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> will
return an error if the acquisition context is in an inappropriate state (e.g.
not started). If the hardware is not producing frames, it will wait
indefinitely.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>After acquisition is started, <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> must be called
frequently enough such that hardware buffers do not overflow.</p>
</div>
<p>After they have been used, frames must be disposed using <code class="docutils literal notranslate"><span class="pre">oni_destroy_frame</span></code>.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Every call to <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code> must be matched by a call to
<code class="docutils literal notranslate"><span class="pre">oni_destroy_frame</span></code>. Not doing so will result in a memory leak.</p>
</div>
</div>
<div class="section" id="writing-data-frames">
<span id="liboni-example-write-frame"></span><h2>Writing Data Frames<a class="headerlink" href="#writing-data-frames" title="Permalink to this headline">¶</a></h2>
<p>Writing frames to an appropriate device in the device table follows similar
steps to reading frames.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Required elements to create frame</span>
<span class="n">oni_frame_t</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">dev_idx</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">data_sz</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// or 16, 24, 32, etc</span>
<span class="kt">char</span> <span class="n">data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>

<span class="c1">// Create a frame</span>
<span class="n">oni_create_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>

<span class="c1">// Write the frame</span>
<span class="n">oni_write_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

<span class="c1">// Dispose the frame</span>
<span class="n">oni_destroy_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</pre></div>
</div>
<p>First, a frame is created using a call to <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code> (analogous to
<code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code>, except that frame data is provided by the user instead of
the hardware). In the preceding example, it is assumed that the user has
queried the device table to ensure that the device with qualified index 256 is
writable and has a write size of 8 bytes. If the device at <code class="docutils literal notranslate"><span class="pre">dev_idx</span></code> does not
accept writes or <code class="docutils literal notranslate"><span class="pre">data</span></code>/<code class="docutils literal notranslate"><span class="pre">data_sz</span></code> are not a multiple of the device write
size, then <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code> will return an error.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When calling <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code>, <code class="docutils literal notranslate"><span class="pre">data</span></code>/<code class="docutils literal notranslate"><span class="pre">data_sz</span></code> can be a
multiple of the write size for a particular device. This way, a frame can be
loaded with multiple data packets that are written to the device as quickly as
the hardware and device driver permit.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Attempting to write multi-packet frames that are larger than
<a class="reference internal" href="onidefs.html#c.&#64;ctx_opts_enum.ONI_OPT_BLOCKWRITESIZE" title="ONI_OPT_BLOCKWRITESIZE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">ONI_OPT_BLOCKWRITESIZE</span></code></a> will result in a error.</p>
</div>
<p>After a frame has been created, it can then be written to to hardware using
<code class="docutils literal notranslate"><span class="pre">oni_write_frame</span></code>. Just like frames produced by <code class="docutils literal notranslate"><span class="pre">oni_read_frame</span></code>, frames
generated by <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code> must be disposed of using
<code class="docutils literal notranslate"><span class="pre">oni_destroy_frame</span></code> when the are no longer needed.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Frames created using <code class="docutils literal notranslate"><span class="pre">oni_create_frame</span></code> can be reused by re-writing
their data field following a frame write</p>
</div>
<p>The following example shows a single frame being used for two writes with a
change in the data field in between writes:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Required elements to create frame</span>
<span class="n">oni_frame_t</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">dev_idx</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">data_sz</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// or 16, 24, 32, etc</span>
<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>

<span class="c1">// Create a frame</span>
<span class="n">oni_create_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>

<span class="c1">// Write the frame</span>
<span class="n">oni_write_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

<span class="c1">// Reuse the same frame</span>
<span class="kt">char</span> <span class="n">new_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">};</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>

<span class="c1">// Write the frame with new_data</span>
<span class="n">oni_write_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

<span class="c1">// Dispose the frame</span>
<span class="n">oni_destroy_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="synchronizing-contexts">
<span id="sync-ctx"></span><h2>Synchronizing Contexts<a class="headerlink" href="#synchronizing-contexts" title="Permalink to this headline">¶</a></h2>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Document.</p>
</div>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="build.html" title="previous page">Building liboni</a>
    <a class='right-next' id="next-link" href="making-drivers.html" title="next page">Writing Drivers</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2010-2021, Open Ephys &amp; Contributors.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>